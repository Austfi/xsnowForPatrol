name: Test Notebooks

on:
  push:
    branches: [ main, master ]
    paths:
      - 'notebooks/**'
      - '.github/workflows/notebook-tests.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'notebooks/**'
      - '.github/workflows/notebook-tests.yml'
  workflow_dispatch:

jobs:
  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install git+https://gitlab.com/avacollabra/postprocessing/xsnow
        pip install nbconvert pytest pytest-nbval
    
    - name: Test notebook execution
      run: |
        # Convert notebooks to check for syntax errors
        for notebook in notebooks/*.ipynb; do
          echo "Checking $notebook..."
          jupyter nbconvert --to notebook --execute --inplace "$notebook" || exit 1
        done
    
    - name: Check notebook outputs
      run: |
        # Basic validation that notebooks can be executed
        python -c "
        import json
        import sys
        
        notebooks = [
            'notebooks/01_introduction_and_loading_data.ipynb',
            'notebooks/02_basic_operations_and_analysis.ipynb',
            'notebooks/03_visualization.ipynb',
            'notebooks/04_advanced_analysis.ipynb',
            'notebooks/05_working_with_custom_data.ipynb',
            'notebooks/06_extending_xsnow.ipynb'
        ]
        
        for nb_path in notebooks:
            try:
                with open(nb_path, 'r') as f:
                    nb = json.load(f)
                print(f'✅ {nb_path}: Valid JSON')
            except Exception as e:
                print(f'❌ {nb_path}: {e}')
                sys.exit(1)
        print('All notebooks are valid!')
        "

